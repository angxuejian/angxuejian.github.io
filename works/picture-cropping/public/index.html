<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>图片裁剪</title>
  <link rel="stylesheet" href="./index.css">
  <style>
    html,
    body {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #app {
      background-color: #000;
      /* max-width: 450px;
      min-width: 320px; */
      height: 100%;
      width: 100%;
      overflow: hidden;

      display: flex;
      align-items: center;
      justify-content: center;
      /* position: relative;
      display: flex;
      align-items: center;
      justify-content: center; */
    }
  </style>
</head>

<body>

  <div id="app">

    <!-- <input onchange="getFile(event)" type="file" accept="image/*"> -->

    <!-- <img class="prev none" src="" alt=""> -->

    <canvas ontouchend='end(event)' ontouchmove='move1(event)' ontouchstart='start(event)' id="canvas"></canvas>

  </div>

  <script>
    const input = document.getElementsByTagName('input')[0]
    const canvas = document.getElementById('canvas')
    const prev = document.getElementsByClassName('prev')[0]
    const avatar = document.getElementsByClassName('bc-avatar')[0]

    let pageX = 0
    let pageY = 0

    let startX = 0
    let startY = 0
    let isTouch = false

    let xx = 0
    let yy = 0
    let ww = 0
    let hh = 0
    let t = {}


    function getFile(event) {
      const file = event.target.files[0]

      const reader = new FileReader()
      reader.readAsDataURL(file)
      reader.onload = function () {

        drawImage(reader.result)
      }
    }

    window.onload = function () {
      drawImage()
    }


    function move1(event) {

      if (!isTouch) return
      event.preventDefault()

      let e = event.touches[0];

      let offsetX = e.pageX - pageX;
      let offsetY = e.pageY - pageY;
      if (hh === 450) {

        t.sx = startX + offsetX;

        console.log(t.sx)
        if (t.sx <= 0) {
          t.sx = 0;
        } else if (t.sx >= (hh - 450)) {
          t.sx = hh - 450;
        }
      }

      drawImage('', t.sx, 0)
      // t.cutImage();
    }

    function start(event) {
      let e = event.touches[0];

      isTouch = true

      pageX = e.pageX;
      pageY = e.pageY;

      startX = xx;
      startY = yy;
    }

    function end(evnet) {
      console.log('33')
      isTouch = false
    }

    function drawImage(src, sx = 0, sy = 0) {
      canvas.width = 375
      canvas.height = 812
      const ctx = canvas.getContext('2d')

      ctx.clearRect(0, 0, 375, 812)
      const img = new Image()

      img.src = src || './assets/c.jpg'
      img.onload = function () {
       
        const [x, y, dw, dh] = getAspectFill(img.width, img.height, 450, 450)

        if (!sx) {
          ww = dw
          hh = dh
          xx = 38
          yy = 210

          ctx.drawImage(img, x, y, dw, dh)
        } else {
          ctx.drawImage(img,sx, (450 - sy) / 2, 450, 450, x, y, dw, dh)
        }

        // prev.src = canvas.toDataURL('image/jpeg', 1)
        // return
        const img2 = new Image()
        img2.src = './assets/bc.png'
        img2.onload = function () {
          ctx.globalAlpha = 0.5
          ctx.drawImage(img2, 0, 0, 375, 812)

          // prev.classList.remove('none')
          // input.classList.add('none')
          // prev.src = canvas.toDataURL('image/jpeg', 1)
        }

      }
    }




    function getAspectFill(width, height, styleW, styleH) {

      let [dw, dh] = []
      let scale = width / height

      // 判断图片的短边是宽还是高
      if (width < height) {
        dw = styleW
        dh = styleW / scale
      } else {
        dw = styleH * scale
        dh = styleH
      }
      let x = (375 - dw) / 2
      let y = (812 - dh) / 2
      return [x, y, dw, dh]
    }
  </script>
</body>

</html>