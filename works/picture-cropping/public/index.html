<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>图片裁剪</title>
  <link rel="stylesheet" href="./index.css">
  <style>
    html,
    body {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #app {
      background-color: #000;
      /* max-width: 450px;
      min-width: 320px; */
      height: 100%;
      width: 100%;
      overflow: hidden;

      display: flex;
      align-items: center;
      justify-content: center;
      /* position: relative;
      display: flex;
      align-items: center;
      justify-content: center; */
    }
  </style>
</head>

<body>

  <div id="app">

    <!-- <input onchange="getFile(event)" type="file" accept="image/*"> -->

    <img class="prev none" src="" alt="">

    <img class="page-bc" src="./assets/bc.png" alt="">
    <div class="box">
      <img class="bc-avatar" src="" alt="">
    </div>
    <!-- <canvas id="canvas"></canvas> -->

  </div>

  <script>
    const input = document.getElementsByTagName('input')[0]
    const canvas = document.getElementById('canvas')
    const prev = document.getElementsByClassName('prev')[0]
    const avatar = document.getElementsByClassName('bc-avatar')[0]

    let pageX = 0
    let pageY = 0

    let startX = 0
    let startY = 0
    let isTouch = false

    let xx = 0
    let yy = 0
    let ww = 0
    let hh = 0



    function getFile(event) {
      const file = event.target.files[0]

      const reader = new FileReader()
      reader.readAsDataURL(file)
      reader.onload = function() {

        drawImage(reader.result) 
      }
    }

    window.onload = function() {
      // drawImage()
      getAvatar()
    }

    function getAvatar() {
      const img = new Image()
      img.src = './assets/a.jpg'
      img.onload = function() {
        const [x, y, w, h] = getAspectFill(img.width, img.height, 450, 450)
        xx = 38;
        yy = 210
        ww = w
        hh = h
        avatar.style = `top: ${y}px; left: ${x}px;width:${w}px;height: ${h}px`
        avatar.src = img.src
      }

      
    }


    avatar.addEventListener('touchmove', function(event) {

      if (!isTouch) return
      let e = event.touches[0];

      let offsetX = e.pageX - pageX;
      let offsetY = e.pageY - pageY;

      console.log(offsetX, offsetY)
      avatar.style.top = offsetY + 'px'
      avatar.style.left = offsetX + 'px'

      // pageX = e.pageX
      // pageY = e.pageY

    })

    avatar.addEventListener('touchstart', function(event) {
      let e = event.touches[0];

      isTouch = true

      pageX = e.pageX;
      pageY = e.pageY;

      startX = xx;
      startY = yy;
    })

    avatar.addEventListener('touchend', function(event) {
      isTouch = false
    })
   
    function drawImage(src) {
      canvas.width  = 375
      canvas.height = 812
      const ctx = canvas.getContext('2d')

      const img = new Image()

      img.src = src || './assets/a.jpg'
      img.onload = function () {
       
        const [dw, dh] = getAspectFill(img.width, img.height, 450, 450)
        
        console.log(dw, dh)
        ctx.drawImage(img, (375 - dw) / 2, (812 - dh) / 2, dw, dh)

        // prev.src = canvas.toDataURL('image/jpeg', 1)
        // return
        const img2 = new Image()
        img2.src = './assets/bc.png'
        img2.onload = function() {
          ctx.globalAlpha = 0.8
          ctx.drawImage(img2, 0, 0, 375, 812)

          prev.classList.remove('none')
          input.classList.add('none')
          prev.src = canvas.toDataURL('image/jpeg', 1)
        }

       
      }
    }


    function getAspectFill(width, height, styleW, styleH) {
  
      let [dw, dh] = []
      let scale = width / height

      // 判断图片的短边是宽还是高
      if (width < height) {
        dw = styleW
        dh = styleW / scale
      } else {
        dw = styleH * scale
        dh = styleH
      }
      let x = (375 - dw) / 2
      let y = (812 - dh) / 2
      return [x, y, dw, dh]
      }
  </script>
</body>

</html>